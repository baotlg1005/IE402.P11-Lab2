<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
	<title>3D - Building Map</title>

	<style>
		html,
		body,
		#viewDiv {
			padding: 0;
			margin: 0;
			height: 100%;
			width: 100%;
		}
	</style>

	<link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
	<script src="https://js.arcgis.com/4.29/"></script>

	<script>

		let jsondata = {
			points: [
			],
			polygons: [
			],
			polyline: [
            ]

		}

		function AddPoint(x, y, z) {
			//add point to jsondata points
			jsondata.points.push({
				type: "point",
				x: x,
				y: y,
				z: z,
				symbol: {
					type: "simple-marker",
					color: [226, 119, 40],
					outline: {
						color: [255, 255, 255],
						width: 2
					}
				},
			});
		}

		function AddPolyline(listPoint, color) {
            //add polyline to jsondata polyline
            jsondata.polyline.push({
                type: "polyline",
                paths: listPoint,
                symbol: {
                    type: "simple-line",
                    color: color,
                    width: 4
                }
            });
        }

		function AddPolygons(listRing, color) {
			//add polygon to jsondata polygons
			jsondata.polygons.push({
				type: "polygon",
				rings: listRing,
				symbol: {
					type: "simple-fill",
					color: color,
					outline: null
				}
			});
		}

		// outerPoint, innerPoint: lists of points for the outer and inner polygons
		// The point order for outerPoint and innerPoint must be the same
		function AddWallWithWindow(outerPoint, innerPoint, color = [255, 255, 255]) {
			ring = outerPoint;
			ring.push(outerPoint[0]);

			ring = [...ring, ...innerPoint.reverse()];

			ring.push(innerPoint[0]);

			AddPolygons(ring, color);
		}

		function CreateCurveLine(leftPoint, rightPoint, color, deg, delta, direction) {

            // Chuyển đổi góc deg thành radian
            let rad = deg * Math.PI / 180;

			// Tính toán khoảng cách giữa left và right
			let dx = rightPoint[0] - leftPoint[0];
			let dy = rightPoint[1] - leftPoint[1];
            let distance = Math.sqrt(dx * dx + dy * dy);

            const d = distance / (2 * Math.sin(rad / 2));

			// Tính tọa độ trung điểm của left và right
			let midX = (leftPoint[0] + rightPoint[0]) / 2;
			let midY = (leftPoint[1] + rightPoint[1]) / 2;

            // Tính vector vuông góc với vector AB
            const perpDx = -dy;
			const perpDy = dx;

            // Chuẩn hóa vector vuông góc
            const len = Math.sqrt(perpDx * perpDx + perpDy * perpDy);
            const ux = perpDx / len;
			const uy = perpDy / len;

			let root = [0,0,leftPoint[2]];

			//toạ độ góc
			if (direction = true) {
                root[0] = midX + d * ux;
                root[1] = midY + d * uy;
			} else {
				root[0] = midX - d * ux;
                root[1] = midY - d * uy;
			}

			// Tính tọa độ các điểm trên đường cong
			let listPoint = [];

			let z = leftPoint[2];

			for (let i = 0; i < delta; i++) {

				let t = i / delta;
				let x = (1 - t) * (1 - t) * leftPoint[0] + 2 * (1 - t) * t * root[0] + t * t * rightPoint[0];
				let y = (1 - t) * (1 - t) * leftPoint[1] + 2 * (1 - t) * t * root[1] + t * t * rightPoint[1];

				

                listPoint.push([x, y, z]);
			}

			listPoint.push(rightPoint);	

			return listPoint;
		}

		function AddCurveWall(listPoint, color, deg, delta, direction) {

			let top = CreateCurveLine(listPoint[0], listPoint[1], color, deg, delta, direction);
			let bottom = CreateCurveLine(listPoint[3], listPoint[2], color, deg, delta, direction);

            AddPolyline(top, [0, 0, 0]);
            AddPolyline(bottom, [0,0,0]);

			rings = [];

			for (let i = top.length - 1; i > 0; i--) {
				let ring = [top[i], top[i - 1], bottom[i - 1], bottom[i], top[i]];

				AddPolygons(ring, color);
            }
		}

		AddPoint(106.72123722906395, 10.794975920016158, 10);

		AddCurveWall(
            listPoint = [
				[106.72123722906395, 10.794975920016158, 10],
				[106.72175578950052, 10.794320746255044, 10],
				[106.72175578950052, 10.794320746255044, 100],
				[106.72123722906395, 10.794975920016158, 100]
            ],
            [255, 0, 0],
            180,
            10,
            false
		)

        AddCurveWall(
            [
                [106, 10, 10],
                [107, 10, 10],
                [107, 10, 10000],
                [106, 10, 10000]
            ],
            [255, 0, 0],
            90,
            5,
            true
        )

		//AddWallWithWindow(
		//	outerPoint = [
		//		[106.72123722906395, 10.794975920016158, 10],
		//		[106.72175578950052, 10.794320746255044, 10],
		//		[106.72175578950052, 10.794320746255044, 100],
		//		[106.72123722906395, 10.794975920016158, 100],
		//	],
		//	innerPoint = [
		//		[106.7214104152098, 10.794757528681288, 20],
		//		[106.72158360135565, 10.794539137347277, 20],
		//		[106.72158360135565, 10.794539137347277, 80],
		//		[106.7214104152098, 10.794757528681288, 80],
		//		[106.7214104152098, 10.794757528681288, 20]

		//	],
		//	color = [255, 0, 0]
		//)

		console.log(jsondata);

		require([
			"esri/Map",
			"esri/views/SceneView",
			"esri/layers/GraphicsLayer",
			"esri/Graphic",
		], function (
			Map, SceneView, GraphicsLayer, Graphic
		) {

			const map = new Map({
				basemap: "topo-vector",
				ground: "world-elevation"
			});

			const view = new SceneView({
				container: "viewDiv",
				map: map,
				camera: {
					position: [106.72123722906395, 10.794975920016158, 300],
					heading: 10,
					tilt: 60
				}
			});
			var createGraphic = function (data) {
				return new Graphic({
					geometry: data,
					symbol: data.symbol,
					attributes: data,
				});
			};
			var graphicsLayer = new GraphicsLayer();

			jsondata.points.forEach(function (data) {
				graphicsLayer.add(createGraphic(data));
			});
			jsondata.polygons.forEach(function (data) {
				graphicsLayer.add(createGraphic(data));
			});
			jsondata.polyline.forEach(function (data) {
                graphicsLayer.add(createGraphic(data));
            });

			map.add(graphicsLayer);
		});

	</script>
</head>

<body>
	<div id="viewDiv"></div>
</body>

</html>